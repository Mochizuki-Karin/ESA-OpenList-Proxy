# 阿里雲ESA-pagesデプロイガイド

## 準備作業

1. 阿里雲アカウントを持ち、ESA-pagesサービスを有効化していることを確認
2. OpenList管理者トークンを取得（OpenList管理ページ → その他設定）

## デプロイ手順

### 方法1：Git経由でのデプロイ（推奨）

1. 本プロジェクトのコードをGitリポジトリ（GitHub、GitLabなど）にアップロード
2. 阿里雲コンソールにログインし、ESA-pagesサービスに移動
3. 「新しいアプリケーション」をクリックし、「Gitリポジトリからインポート」を選択
4. Gitリポジトリを接続し、ブランチを選択
5. ビルド設定を構成：
   - ビルドコマンド: `npm install`
   - 出力ディレクトリ: `.` (ルートディレクトリ)
   - 実行コマンド: `npm start`

### 方法2：手動アップロードでのデプロイ

1. 本プロジェクトのすべてのファイルをZIPファイルにパック
2. 阿里雲コンソールにログインし、ESA-pagesサービスに移動
3. 「新しいアプリケーション」をクリックし、「コードをアップロード」を選択
4. ZIPファイルをアップロード
5. ビルド設定を構成（同上）

## 環境変数設定

ESA-pagesコンソールで、アプリケーションを見つけ、「環境変数」設定に移動：

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `ADDRESS` | `あなたのOpenListサーバーアドレス` | 例: `https://your-openlist.example.com` |
| `TOKEN` | `あなたの管理者トークン` | OpenList管理ページから取得 |
| `WORKER_ADDRESS` | `あなたのESA-pagesアプリケーションアドレス` | オプション、例: `https://your-app.esa-pages.com` |
| `DISABLE_SIGN` | `false` | セキュリティのためにfalseを維持することを推奨 |

## デプロイ検証

デプロイ完了後、以下の方法でプロキシサーバーをテストできます：

1. ESA-pagesアプリケーションアドレスにアクセス、空白ページが表示される（正常、ルートパス処理がないため）
2. テストスクリプトを使用して署名アルゴリズムを検証：
   ```bash
   cd openlist-proxy-server
   node test-signature.js
   ```

## OpenListクライアント設定

OpenListクライアントでプロキシURLを設定：

```
https://あなたのESA-pagesドメイン/{path}?sign={signature}
```

署名生成方法はREADME.mdの例を参照。

## よくある質問

### Q: デプロイ後404エラーが発生
A: 環境変数が正しく設定されているか確認、特にADDRESSとTOKEN

### Q: 署名検証失敗
A: TOKEN値がOpenList管理ページのものと一致しているか確認、時間同期を確認

### Q: CORSクロスオリジン問題
A: プロキシサーバーは組み込みのCORSサポートがありますが、問題が残る場合はESA-pagesのクロスオリジン設定を確認

### Q: ファイルダウンロード失敗
A: OpenListサーバーが正常に動作しているか確認、ネットワーク接続を確認

## 監視とログ

- ESA-pagesコンソールでアプリケーションログを確認
- リクエスト量とエラーレートを監視
- 定期的にTOKENの安全性を確認

## セキュリティ推奨事項

1. 定期的にTOKENを変更
2. DISABLE_SIGN=falseを維持
3. 異常なリクエストを監視
4. アクセス頻度制限を設定（ESA-pagesがサポートしている場合）
